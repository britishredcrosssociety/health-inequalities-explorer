# ---- Load libs & helpers ----
library(tidyverse)
library(healthyr)
library(geographr)
library(sf)
library(ggridges)
library(compositr)

hb <- boundaries_hb19 |>
  st_drop_geometry()

# Popuation counts
# Source: https://www.opendata.nhs.scot/dataset/population-estimates
pop_raw <- read_csv(
  "https://www.opendata.nhs.scot/datastore/dump/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1?bom=True"
)

pop_scotland <- pop_raw |>
  filter(Year == 2021) |>
  filter(Sex == "All") |>
  filter(HB != "S92000003") |>
  select(hb19_code = HB, population = AllAges)

# ---- RTT ----
# Higher = worse performance
rtt <- scotland_rtt_hb |>
  filter(date >= max(date) %m-% months(2)) |> # Last quarter
  filter(hb19_code != "SB0801") |>
  group_by(hb19_code) |>
  summarise(
    number = mean(waits_over_18_weeks_count),
    percent = mean(waits_over_18_weeks_percent)
  ) |>
  mutate(
    variable = "Referral to treatment \nwaiting times (Nov 22 - Dec 22)",
    .after = hb19_code
  )

# ---- Beds ----
# Higher = better performance
available_beds <- scotland_beds |>
  filter(date >= max(date)) |> # Note: data is quarterly
  filter(specialty == "All Specialties") |>
  mutate(percent_avilable = 1 - percent_occupied_beds) |>
  mutate(variable = "Bed availability \n(Q4 2022)") |>
  select(
    hb19_code,
    variable,
    number = average_number_available_staffed_beds,
    percent = percent_avilable
  )

# ---- Delayed discharges ----
# Higher = worse
delayed_discharge_monthly <- scotland_delayed_discharge_hb |>
  filter(hb_code != "S92000003") |>
  filter(date >= max(date) %m-% months(2)) |> # Last quarter
  filter(age_group == "18-74" | age_group == "75plus") |>
  filter(delay_reason == "All Delay Reasons") |>
  rename(hb19_code = hb_code) |>
  group_by(hb19_code, date) |>
  summarise(
    num_delayed_bed_days = sum(num_delayed_bed_days),
    average_daily_delayed_beds = sum(average_daily_delayed_beds)
  ) |>
  ungroup()

delayed_discharge_summary <- delayed_discharge_monthly |>
  group_by(hb19_code) |>
  summarise(
    num_delayed_bed_days = mean(num_delayed_bed_days),
    average_daily_delayed_beds = mean(average_daily_delayed_beds)
  ) |>
  select(-num_delayed_bed_days)

delayed_discharges <- delayed_discharge_summary |>
  left_join(pop_scotland) |>
  mutate(beds_per_10000 = average_daily_delayed_beds / population * 10000) |>
  select(
    hb19_code,
    number = average_daily_delayed_beds,
    percent = beds_per_10000
  ) |>
  mutate(
    variable = "Delayed discharges \n(July 22 - Sept 22 average)",
    .after = hb19_code
  )

# ---- Combine & rename (pretty printing) ----
metrics_joined <- bind_rows(
  rtt,
  available_beds,
  delayed_discharges
) |>
  left_join(hb) |>
  select(-hb19_code) |>
  rename(area_name = hb19_name) |>
  relocate(area_name)

# ---- Normalise/scale ----
secondary_care_scaled <-
  metrics_joined |>
  group_by(variable) |>
  mutate(scaled = positional_normalisation(percent)) |>
  ungroup()

# ---- Align indicator polarity ----
# Align so higher value = better health
# Flip RTT and delayed discharges
secondary_care_polarised <- secondary_care_scaled |>
  mutate(
    scaled = case_when(
      variable == "Referral to treatment \nwaiting times (Nov 22 - Dec 22)" ~ scaled * -1,
      variable == "Delayed discharges \n(July 22 - Sept 22 average)" ~ scaled * -1,
      TRUE ~ scaled
    )
  )

# Check distributions
secondary_care_polarised |>
  ggplot(aes(x = scaled, y = variable)) +
  geom_density_ridges(scale = 4) +
  scale_y_discrete(expand = c(0, 0)) + # will generally have to set the `expand` option
  scale_x_continuous(expand = c(0, 0)) + # for both axes to remove unneeded padding
  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  theme_ridges()

# ---- Add plot labels ----
scotland_hb_secondary_care <- secondary_care_polarised |>
  mutate(
    label = case_when(
      variable == "Referral to treatment \nwaiting times (Nov 22 - Dec 22)" ~ paste0(
        "<b>", area_name, "</b>",
        "<br>",
        "<br>", "No. waiting over 18 weeks: ", round(number),
        "<br>", "Percentage waiting over 18 weeks: ", round(percent * 100, 1), "%"
      ),
      variable == "Bed availability \n(Q4 2022)" ~ paste0(
        "<b>", area_name, "</b>",
        "<br>",
        "<br>", "No. of available beds: ", round(number),
        "<br>", "Percentage of all beds available: ", round(percent * 100, 1), "%"
      ),
      variable == "Delayed discharges \n(July 22 - Sept 22 average)" ~ paste0(
        "<b>", area_name, "</b>",
        "<br>",
        "<br>", "Average daily no. of delayed beds: ", round(number),
        "<br>", "Average daily no. of delayed beds per 10,000 people: ", round(percent * 100, 1), "%"
      )
    )
  )

usethis::use_data(scotland_hb_secondary_care, overwrite = TRUE)
